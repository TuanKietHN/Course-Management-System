-- ============================================
-- V1__init_schema.sql
-- Initial database schema
-- PostgreSQL
-- ============================================

-- ======================
-- TABLE: semesters
-- ======================
CREATE TABLE semesters (
                           id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           created_at TIMESTAMP NOT NULL,
                           updated_at TIMESTAMP NOT NULL,
                           active BOOLEAN NOT NULL,
                           code VARCHAR(255) NOT NULL,
                           start_date DATE NOT NULL,
                           end_date DATE NOT NULL,
                           name VARCHAR(255) NOT NULL,
                           CONSTRAINT uk_semesters_code UNIQUE (code)
);

-- ======================
-- TABLE: subjects
-- ======================
CREATE TABLE subjects (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          created_at TIMESTAMP NOT NULL,
                          updated_at TIMESTAMP NOT NULL,
                          active BOOLEAN NOT NULL,
                          code VARCHAR(255) NOT NULL,
                          credit INTEGER NOT NULL,
                          description TEXT,
                          name VARCHAR(255) NOT NULL,
                          CONSTRAINT uk_subjects_code UNIQUE (code)
);

-- ======================
-- TABLE: users
-- ======================
CREATE TABLE users (
                       id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       created_at TIMESTAMP NOT NULL,
                       updated_at TIMESTAMP NOT NULL,
                       email VARCHAR(255) NOT NULL,
                       password VARCHAR(255) NOT NULL,
                       role VARCHAR(255) NOT NULL,
                       username VARCHAR(255) NOT NULL,
                       CONSTRAINT uk_users_email UNIQUE (email),
                       CONSTRAINT uk_users_username UNIQUE (username)
);

-- ======================
-- TABLE: courses
-- ======================
CREATE TABLE courses (
                         id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         created_at TIMESTAMP NOT NULL,
                         updated_at TIMESTAMP NOT NULL,
                         active BOOLEAN NOT NULL,
                         code VARCHAR(255) NOT NULL,
                         current_students INTEGER NOT NULL,
                         max_students INTEGER NOT NULL,
                         name VARCHAR(255) NOT NULL,
                         semester_id BIGINT NOT NULL,
                         subject_id BIGINT NOT NULL,
                         teacher_id BIGINT,
                         CONSTRAINT uk_courses_code UNIQUE (code),
                         CONSTRAINT fk_courses_semester FOREIGN KEY (semester_id) REFERENCES semesters (id),
                         CONSTRAINT fk_courses_subject FOREIGN KEY (subject_id) REFERENCES subjects (id),
                         CONSTRAINT fk_courses_teacher FOREIGN KEY (teacher_id) REFERENCES users (id)
);

-- ======================
-- TABLE: enrollments
-- ======================
CREATE TABLE enrollments (
                             id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                             created_at TIMESTAMP NOT NULL,
                             updated_at TIMESTAMP NOT NULL,
                             grade DOUBLE PRECISION,
                             status VARCHAR(255) NOT NULL,
                             course_id BIGINT NOT NULL,
                             student_id BIGINT NOT NULL,
                             CONSTRAINT uk_enrollments_course_student UNIQUE (course_id, student_id),
                             CONSTRAINT fk_enrollments_course FOREIGN KEY (course_id) REFERENCES courses (id),
                             CONSTRAINT fk_enrollments_student FOREIGN KEY (student_id) REFERENCES users (id)
);

-- =====================================================
-- INITIAL DATA (SEED DATA)
-- =====================================================

-- semesters
INSERT INTO semesters (id, created_at, updated_at, active, code, start_date, end_date, name)
VALUES
    (1, '2026-02-10 12:27:12', '2026-02-10 12:27:12', TRUE, 'HK1_2425', '2024-09-01', '2025-01-15', 'Học kỳ 1 2024-2025'),
    (2, '2026-02-10 12:27:12', '2026-02-10 12:27:12', FALSE, 'HK2_2425', '2025-01-20', '2025-06-15', 'Học kỳ 2 2024-2025');

-- subjects
INSERT INTO subjects (id, created_at, updated_at, active, code, credit, description, name)
VALUES
    (1, '2026-02-10 12:27:12', '2026-02-10 12:27:12', TRUE, 'JAVA001', 3, 'Môn học cung cấp kiến thức nền tảng về ngôn ngữ lập trình Java.', 'Lập trình Java căn bản'),
    (2, '2026-02-10 12:27:12', '2026-02-10 12:27:12', TRUE, 'WEB002', 4, 'Xây dựng ứng dụng web hiện đại sử dụng Spring Boot framework.', 'Lập trình Web với Spring Boot'),
    (3, '2026-02-10 12:27:12', '2026-02-10 12:27:12', TRUE, 'DB003', 3, 'Kiến thức về thiết kế và quản trị cơ sở dữ liệu quan hệ.', 'Cơ sở dữ liệu');

-- users
INSERT INTO users (id, created_at, updated_at, email, password, role, username)
VALUES
    (3, '2026-02-10 12:27:12', '2026-02-10 12:27:12', 'admin@nws.com.vn',
     '$2a$10$H5mjFs1H.VUbzZnmZgNwxOopdEOI/eaob2QNrs5GQeIi/YfQSQA/u', 'ROLE_ADMIN', 'admin'),
    (4, '2026-02-10 12:27:12', '2026-02-10 12:27:12', 'teacher@nws.com.vn',
     '$2a$10$ilFd7HwXVEYrwrYjRBo5aefJ9vY1xKe8VkrmPRtcHTEGHzNCGJeq.', 'ROLE_TEACHER', 'teacher'),
    (5, '2026-02-10 12:27:12', '2026-02-10 12:27:12', 'student@nws.com.vn',
     '$2a$10$jZh02f/DBaYNxVtz/Fk.w.uEVLg/JxBgjTBZvcsnh4BclMI5rj/s6', 'ROLE_STUDENT', 'student');

-- courses
INSERT INTO courses (id, created_at, updated_at, active, code, current_students, max_students, name, semester_id, subject_id, teacher_id)
VALUES
    (1, '2026-02-10 12:27:12', '2026-02-10 12:27:12', TRUE,
     'JAVA001_HK1_01', 0, 30, 'Lớp Java 01 - HK1', 1, 1, 4);
